licenses(["notice"])

package(default_visibility = ["//visibility:public"])

EXPORT_TEMPLATE = """
#ifndef @_EXPORT_H
#define @_EXPORT_H

#define @_EXPORT
#define @_NO_EXPORT

#ifndef @_DEPRECATED
#  define @_DEPRECATED __attribute__ ((__deprecated__))
#endif

#endif
"""

VERSION_TEMPLATE = """#ifndef JPEGXL_VERSION_H_
#define JPEGXL_VERSION_H_

#define JPEGXL_MAJOR_VERSION 0
#define JPEGXL_MINOR_VERSION 12
#define JPEGXL_PATCH_VERSION 0

#endif /* JPEGXL_VERSION_H_ */
"""

INCLUDES_DIR = "lib/include"

JXL_EXPORT_H = INCLUDES_DIR + "/jxl/jxl_export.h"

JXL_CMS_EXPORT_H = INCLUDES_DIR + "/jxl/jxl_cms_export.h"

JXL_THREADS_EXPORT_H = INCLUDES_DIR + "/jxl/jxl_threads_export.h"

JXL_VERSION_H = INCLUDES_DIR + "/jxl/version.h"

genrule(
    name = "create_jxl_export",
    outs = [JXL_EXPORT_H],
    cmd = "echo '" + EXPORT_TEMPLATE.replace("@", "JXL") + "' > $@",
)

genrule(
    name = "create_jxl_cms_export",
    outs = [JXL_CMS_EXPORT_H],
    cmd = "echo '" + EXPORT_TEMPLATE.replace("@", "JXL_CMS") + "' > $@",
)

genrule(
    name = "create_jxl_threads_export",
    outs = [JXL_THREADS_EXPORT_H],
    cmd = "echo '" + EXPORT_TEMPLATE.replace("@", "JXL_THREADS") + "' > $@",
)

genrule(
    name = "create_jxl_version",
    outs = [JXL_VERSION_H],
    cmd = "echo '" + VERSION_TEMPLATE + "' > $@",
)

cc_library(
    name = "jxl_version",
    hdrs = [JXL_VERSION_H],
    strip_include_prefix = INCLUDES_DIR,
)

cc_library(
    name = "includes",
    hdrs = [
        "lib/include/jxl/cms.h",
        "lib/include/jxl/cms_interface.h",
        "lib/include/jxl/codestream_header.h",
        "lib/include/jxl/color_encoding.h",
        "lib/include/jxl/compressed_icc.h",
        "lib/include/jxl/decode.h",
        "lib/include/jxl/decode_cxx.h",
        "lib/include/jxl/encode.h",
        "lib/include/jxl/encode_cxx.h",
        "lib/include/jxl/gain_map.h",
        "lib/include/jxl/memory_manager.h",
        "lib/include/jxl/parallel_runner.h",
        "lib/include/jxl/stats.h",
        "lib/include/jxl/types.h",
        JXL_CMS_EXPORT_H,
        JXL_EXPORT_H,
    ],
    strip_include_prefix = INCLUDES_DIR,
    deps = [":jxl_version"],
)

cc_library(
    name = "base",
    hdrs = [
        "lib/jxl/base/arch_macros.h",
        "lib/jxl/base/bits.h",
        "lib/jxl/base/byte_order.h",
        "lib/jxl/base/c_callback_support.h",
        "lib/jxl/base/common.h",
        "lib/jxl/base/compiler_specific.h",
        "lib/jxl/base/data_parallel.h",
        "lib/jxl/base/exif.h",
        "lib/jxl/base/float.h",
        "lib/jxl/base/iaca.h",
        "lib/jxl/base/include_jpeglib.h",
        "lib/jxl/base/matrix_ops.h",
        "lib/jxl/base/os_macros.h",
        "lib/jxl/base/override.h",
        "lib/jxl/base/printf_macros.h",
        "lib/jxl/base/random.h",
        "lib/jxl/base/rect.h",
        "lib/jxl/base/sanitizer_definitions.h",
        "lib/jxl/base/sanitizers.h",
        "lib/jxl/base/scope_guard.h",
        "lib/jxl/base/span.h",
        "lib/jxl/base/status.h",
    ],
    textual_hdrs = [
        "lib/jxl/base/fast_math-inl.h",
        "lib/jxl/base/rational_polynomial-inl.h",
    ],
    deps = [
        ":includes",
        "@highway//:hwy",
    ],
)

cc_library(
    name = "jpegxl_threads",
    srcs = [
        "lib/threads/resizable_parallel_runner.cc",
        "lib/threads/thread_parallel_runner.cc",
        "lib/threads/thread_parallel_runner_internal.cc",
    ],
    hdrs = [
        "lib/include/jxl/resizable_parallel_runner.h",
        "lib/include/jxl/resizable_parallel_runner_cxx.h",
        "lib/include/jxl/thread_parallel_runner.h",
        "lib/include/jxl/thread_parallel_runner_cxx.h",
        "lib/threads/thread_parallel_runner_internal.h",
        JXL_THREADS_EXPORT_H,
    ],
    strip_include_prefix = INCLUDES_DIR,
    deps = [
        ":base",
        ":includes",
    ],
)

cc_library(
    name = "jpegxl",
    srcs = [
        "lib/jxl/ac_strategy.cc",
        "lib/jxl/alpha.cc",
        "lib/jxl/ans_common.cc",
        "lib/jxl/blending.cc",
        "lib/jxl/box_content_decoder.cc",
        "lib/jxl/butteraugli/butteraugli.cc",
        "lib/jxl/chroma_from_luma.cc",
        "lib/jxl/cms/jxl_cms.cc",
        "lib/jxl/coeff_order.cc",
        "lib/jxl/color_encoding_internal.cc",
        "lib/jxl/compressed_dc.cc",
        "lib/jxl/convolve_slow.cc",
        "lib/jxl/convolve_symmetric5.cc",
        "lib/jxl/dct_scales.cc",
        "lib/jxl/dec_ans.cc",
        "lib/jxl/dec_bit_reader.cc",
        "lib/jxl/dec_cache.cc",
        "lib/jxl/dec_context_map.cc",
        "lib/jxl/dec_external_image.cc",
        "lib/jxl/dec_frame.cc",
        "lib/jxl/dec_group.cc",
        "lib/jxl/dec_group_border.cc",
        "lib/jxl/dec_huffman.cc",
        "lib/jxl/dec_modular.cc",
        "lib/jxl/dec_noise.cc",
        "lib/jxl/dec_patch_dictionary.cc",
        "lib/jxl/dec_xyb.cc",
        "lib/jxl/decode.cc",
        "lib/jxl/decode_to_jpeg.cc",
        "lib/jxl/enc_ac_strategy.cc",
        "lib/jxl/enc_adaptive_quantization.cc",
        "lib/jxl/enc_ans.cc",
        "lib/jxl/enc_ans_simd.cc",
        "lib/jxl/enc_aux_out.cc",
        "lib/jxl/enc_bit_writer.cc",
        "lib/jxl/enc_butteraugli_comparator.cc",
        "lib/jxl/enc_cache.cc",
        "lib/jxl/enc_chroma_from_luma.cc",
        "lib/jxl/enc_cluster.cc",
        "lib/jxl/enc_coeff_order.cc",
        "lib/jxl/enc_comparator.cc",
        "lib/jxl/enc_context_map.cc",
        "lib/jxl/enc_convolve_separable5.cc",
        "lib/jxl/enc_debug_image.cc",
        "lib/jxl/enc_detect_dots.cc",
        "lib/jxl/enc_dot_dictionary.cc",
        "lib/jxl/enc_entropy_coder.cc",
        "lib/jxl/enc_external_image.cc",
        "lib/jxl/enc_fields.cc",
        "lib/jxl/enc_frame.cc",
        "lib/jxl/enc_gaborish.cc",
        "lib/jxl/enc_group.cc",
        "lib/jxl/enc_heuristics.cc",
        "lib/jxl/enc_huffman.cc",
        "lib/jxl/enc_huffman_tree.cc",
        "lib/jxl/enc_icc_codec.cc",
        "lib/jxl/enc_image_bundle.cc",
        "lib/jxl/enc_linalg.cc",
        "lib/jxl/enc_lz77.cc",
        "lib/jxl/enc_modular.cc",
        "lib/jxl/enc_modular_simd.cc",
        "lib/jxl/enc_noise.cc",
        "lib/jxl/enc_patch_dictionary.cc",
        "lib/jxl/enc_photon_noise.cc",
        "lib/jxl/enc_progressive_split.cc",
        "lib/jxl/enc_quant_weights.cc",
        "lib/jxl/enc_splines.cc",
        "lib/jxl/enc_toc.cc",
        "lib/jxl/enc_transforms.cc",
        "lib/jxl/enc_xyb.cc",
        "lib/jxl/encode.cc",
        "lib/jxl/entropy_coder.cc",
        "lib/jxl/epf.cc",
        "lib/jxl/fields.cc",
        "lib/jxl/frame_header.cc",
        "lib/jxl/headers.cc",
        "lib/jxl/huffman_table.cc",
        "lib/jxl/icc_codec.cc",
        "lib/jxl/icc_codec_common.cc",
        "lib/jxl/image.cc",
        "lib/jxl/image_bundle.cc",
        "lib/jxl/image_metadata.cc",
        "lib/jxl/image_ops.cc",
        "lib/jxl/jpeg/dec_jpeg_data.cc",
        "lib/jxl/jpeg/dec_jpeg_data_writer.cc",
        "lib/jxl/jpeg/enc_jpeg_data.cc",
        "lib/jxl/jpeg/enc_jpeg_data_reader.cc",
        "lib/jxl/jpeg/enc_jpeg_huffman_decode.cc",
        "lib/jxl/jpeg/jpeg_data.cc",
        "lib/jxl/loop_filter.cc",
        "lib/jxl/luminance.cc",
        "lib/jxl/memory_manager_internal.cc",
        "lib/jxl/modular/encoding/dec_ma.cc",
        "lib/jxl/modular/encoding/enc_debug_tree.cc",
        "lib/jxl/modular/encoding/enc_encoding.cc",
        "lib/jxl/modular/encoding/enc_ma.cc",
        "lib/jxl/modular/encoding/encoding.cc",
        "lib/jxl/modular/modular_image.cc",
        "lib/jxl/modular/transform/enc_palette.cc",
        "lib/jxl/modular/transform/enc_rct.cc",
        "lib/jxl/modular/transform/enc_squeeze.cc",
        "lib/jxl/modular/transform/enc_transform.cc",
        "lib/jxl/modular/transform/palette.cc",
        "lib/jxl/modular/transform/rct.cc",
        "lib/jxl/modular/transform/squeeze.cc",
        "lib/jxl/modular/transform/squeeze_params.cc",
        "lib/jxl/modular/transform/transform.cc",
        "lib/jxl/opsin_params.cc",
        "lib/jxl/passes_state.cc",
        "lib/jxl/quant_weights.cc",
        "lib/jxl/quantizer.cc",
        "lib/jxl/render_pipeline/low_memory_render_pipeline.cc",
        "lib/jxl/render_pipeline/render_pipeline.cc",
        "lib/jxl/render_pipeline/render_pipeline_stage.cc",
        "lib/jxl/render_pipeline/simple_render_pipeline.cc",
        "lib/jxl/render_pipeline/stage_blending.cc",
        "lib/jxl/render_pipeline/stage_chroma_upsampling.cc",
        "lib/jxl/render_pipeline/stage_cms.cc",
        "lib/jxl/render_pipeline/stage_epf.cc",
        "lib/jxl/render_pipeline/stage_from_linear.cc",
        "lib/jxl/render_pipeline/stage_gaborish.cc",
        "lib/jxl/render_pipeline/stage_noise.cc",
        "lib/jxl/render_pipeline/stage_patches.cc",
        "lib/jxl/render_pipeline/stage_splines.cc",
        "lib/jxl/render_pipeline/stage_spot.cc",
        "lib/jxl/render_pipeline/stage_to_linear.cc",
        "lib/jxl/render_pipeline/stage_tone_mapping.cc",
        "lib/jxl/render_pipeline/stage_upsampling.cc",
        "lib/jxl/render_pipeline/stage_write.cc",
        "lib/jxl/render_pipeline/stage_xyb.cc",
        "lib/jxl/render_pipeline/stage_ycbcr.cc",
        "lib/jxl/simd_util.cc",
        "lib/jxl/splines.cc",
        "lib/jxl/toc.cc",
    ],
    hdrs = [
        "lib/include/jxl/cms.h",
        "lib/include/jxl/cms_interface.h",
        "lib/include/jxl/codestream_header.h",
        "lib/include/jxl/color_encoding.h",
        "lib/include/jxl/compressed_icc.h",
        "lib/include/jxl/decode.h",
        "lib/include/jxl/decode_cxx.h",
        "lib/include/jxl/encode.h",
        "lib/include/jxl/encode_cxx.h",
        "lib/include/jxl/gain_map.h",
        "lib/include/jxl/memory_manager.h",
        "lib/include/jxl/parallel_runner.h",
        "lib/include/jxl/stats.h",
        "lib/include/jxl/types.h",
        "lib/jxl/ac_context.h",
        "lib/jxl/ac_strategy.h",
        "lib/jxl/alpha.h",
        "lib/jxl/ans_common.h",
        "lib/jxl/ans_params.h",
        "lib/jxl/blending.h",
        "lib/jxl/box_content_decoder.h",
        "lib/jxl/butteraugli/butteraugli.h",
        "lib/jxl/chroma_from_luma.h",
        "lib/jxl/cms/color_encoding_cms.h",
        "lib/jxl/cms/jxl_cms_internal.h",
        "lib/jxl/cms/opsin_params.h",
        "lib/jxl/cms/tone_mapping.h",
        "lib/jxl/cms/transfer_functions.h",
        "lib/jxl/coeff_order.h",
        "lib/jxl/coeff_order_fwd.h",
        "lib/jxl/color_encoding_internal.h",
        "lib/jxl/common.h",
        "lib/jxl/compressed_dc.h",
        "lib/jxl/convolve.h",
        "lib/jxl/dct_scales.h",
        "lib/jxl/dct_util.h",
        "lib/jxl/dec_ans.h",
        "lib/jxl/dec_bit_reader.h",
        "lib/jxl/dec_cache.h",
        "lib/jxl/dec_context_map.h",
        "lib/jxl/dec_external_image.h",
        "lib/jxl/dec_frame.h",
        "lib/jxl/dec_group.h",
        "lib/jxl/dec_group_border.h",
        "lib/jxl/dec_huffman.h",
        "lib/jxl/dec_modular.h",
        "lib/jxl/dec_noise.h",
        "lib/jxl/dec_patch_dictionary.h",
        "lib/jxl/dec_xyb.h",
        "lib/jxl/decode_to_jpeg.h",
        "lib/jxl/enc_ac_strategy.h",
        "lib/jxl/enc_adaptive_quantization.h",
        "lib/jxl/enc_ans.h",
        "lib/jxl/enc_ans_params.h",
        "lib/jxl/enc_ans_simd.h",
        "lib/jxl/enc_aux_out.h",
        "lib/jxl/enc_bit_writer.h",
        "lib/jxl/enc_butteraugli_comparator.h",
        "lib/jxl/enc_cache.h",
        "lib/jxl/enc_chroma_from_luma.h",
        "lib/jxl/enc_cluster.h",
        "lib/jxl/enc_coeff_order.h",
        "lib/jxl/enc_comparator.h",
        "lib/jxl/enc_context_map.h",
        "lib/jxl/enc_debug_image.h",
        "lib/jxl/enc_detect_dots.h",
        "lib/jxl/enc_dot_dictionary.h",
        "lib/jxl/enc_entropy_coder.h",
        "lib/jxl/enc_external_image.h",
        "lib/jxl/enc_fast_lossless.h",
        "lib/jxl/enc_fields.h",
        "lib/jxl/enc_frame.h",
        "lib/jxl/enc_gaborish.h",
        "lib/jxl/enc_gamma_correct.h",
        "lib/jxl/enc_group.h",
        "lib/jxl/enc_heuristics.h",
        "lib/jxl/enc_huffman.h",
        "lib/jxl/enc_huffman_tree.h",
        "lib/jxl/enc_icc_codec.h",
        "lib/jxl/enc_image_bundle.h",
        "lib/jxl/enc_linalg.h",
        "lib/jxl/enc_lz77.h",
        "lib/jxl/enc_modular.h",
        "lib/jxl/enc_modular_simd.h",
        "lib/jxl/enc_noise.h",
        "lib/jxl/enc_optimize.h",
        "lib/jxl/enc_params.h",
        "lib/jxl/enc_patch_dictionary.h",
        "lib/jxl/enc_photon_noise.h",
        "lib/jxl/enc_progressive_split.h",
        "lib/jxl/enc_quant_weights.h",
        "lib/jxl/enc_splines.h",
        "lib/jxl/enc_toc.h",
        "lib/jxl/enc_transforms.h",
        "lib/jxl/enc_xyb.h",
        "lib/jxl/encode_internal.h",
        "lib/jxl/entropy_coder.h",
        "lib/jxl/epf.h",
        "lib/jxl/field_encodings.h",
        "lib/jxl/fields.h",
        "lib/jxl/frame_dimensions.h",
        "lib/jxl/frame_header.h",
        "lib/jxl/headers.h",
        "lib/jxl/huffman_table.h",
        "lib/jxl/icc_codec.h",
        "lib/jxl/icc_codec_common.h",
        "lib/jxl/image.h",
        "lib/jxl/image_bundle.h",
        "lib/jxl/image_metadata.h",
        "lib/jxl/image_ops.h",
        "lib/jxl/jpeg/dec_jpeg_data.h",
        "lib/jxl/jpeg/dec_jpeg_data_writer.h",
        "lib/jxl/jpeg/dec_jpeg_output_chunk.h",
        "lib/jxl/jpeg/dec_jpeg_serialization_state.h",
        "lib/jxl/jpeg/enc_jpeg_data.h",
        "lib/jxl/jpeg/enc_jpeg_data_reader.h",
        "lib/jxl/jpeg/enc_jpeg_huffman_decode.h",
        "lib/jxl/jpeg/jpeg_data.h",
        "lib/jxl/lehmer_code.h",
        "lib/jxl/loop_filter.h",
        "lib/jxl/luminance.h",
        "lib/jxl/memory_manager_internal.h",
        "lib/jxl/modular/encoding/context_predict.h",
        "lib/jxl/modular/encoding/dec_ma.h",
        "lib/jxl/modular/encoding/enc_debug_tree.h",
        "lib/jxl/modular/encoding/enc_encoding.h",
        "lib/jxl/modular/encoding/enc_ma.h",
        "lib/jxl/modular/encoding/encoding.h",
        "lib/jxl/modular/encoding/ma_common.h",
        "lib/jxl/modular/modular_image.h",
        "lib/jxl/modular/options.h",
        "lib/jxl/modular/transform/enc_palette.h",
        "lib/jxl/modular/transform/enc_rct.h",
        "lib/jxl/modular/transform/enc_squeeze.h",
        "lib/jxl/modular/transform/enc_transform.h",
        "lib/jxl/modular/transform/palette.h",
        "lib/jxl/modular/transform/rct.h",
        "lib/jxl/modular/transform/squeeze.h",
        "lib/jxl/modular/transform/squeeze_params.h",
        "lib/jxl/modular/transform/transform.h",
        "lib/jxl/noise.h",
        "lib/jxl/opsin_params.h",
        "lib/jxl/pack_signed.h",
        "lib/jxl/padded_bytes.h",
        "lib/jxl/passes_state.h",
        "lib/jxl/patch_dictionary_internal.h",
        "lib/jxl/quant_weights.h",
        "lib/jxl/quantizer.h",
        "lib/jxl/render_pipeline/low_memory_render_pipeline.h",
        "lib/jxl/render_pipeline/render_pipeline.h",
        "lib/jxl/render_pipeline/render_pipeline_stage.h",
        "lib/jxl/render_pipeline/simple_render_pipeline.h",
        "lib/jxl/render_pipeline/stage_blending.h",
        "lib/jxl/render_pipeline/stage_chroma_upsampling.h",
        "lib/jxl/render_pipeline/stage_cms.h",
        "lib/jxl/render_pipeline/stage_epf.h",
        "lib/jxl/render_pipeline/stage_from_linear.h",
        "lib/jxl/render_pipeline/stage_gaborish.h",
        "lib/jxl/render_pipeline/stage_noise.h",
        "lib/jxl/render_pipeline/stage_patches.h",
        "lib/jxl/render_pipeline/stage_splines.h",
        "lib/jxl/render_pipeline/stage_spot.h",
        "lib/jxl/render_pipeline/stage_to_linear.h",
        "lib/jxl/render_pipeline/stage_tone_mapping.h",
        "lib/jxl/render_pipeline/stage_upsampling.h",
        "lib/jxl/render_pipeline/stage_write.h",
        "lib/jxl/render_pipeline/stage_xyb.h",
        "lib/jxl/render_pipeline/stage_ycbcr.h",
        "lib/jxl/simd_util.h",
        "lib/jxl/splines.h",
        "lib/jxl/toc.h",
        JXL_CMS_EXPORT_H,
        JXL_EXPORT_H,
    ],
    defines = [
        "JPEGXL_ENABLE_SKCMS=1",
        "FJXL_STANDALONE=0",
        "HWY_DISABLED_TARGETS=HWY_AVX3+HWY_AVX3_DL+HWY_AVX3_ZEN4+HWY_AVX3_SPR",
    ],
    strip_include_prefix = INCLUDES_DIR,
    textual_hdrs = [
        "lib/jxl/cms/tone_mapping-inl.h",
        "lib/jxl/cms/transfer_functions-inl.h",
        "lib/jxl/convolve-inl.h",
        "lib/jxl/dct-inl.h",
        "lib/jxl/dct_block-inl.h",
        "lib/jxl/dec_transforms-inl.h",
        "lib/jxl/dec_xyb-inl.h",
        "lib/jxl/enc_fast_lossless.cc",
        "lib/jxl/enc_transforms-inl.h",
        "lib/jxl/inverse_mtf-inl.h",
        "lib/jxl/quantizer-inl.h",
        "lib/jxl/simd_util-inl.h",
        "lib/jxl/transpose-inl.h",
        "lib/jxl/xorshift128plus-inl.h",
    ],
    deps = [
        ":base",
        ":includes",
        ":jxl_version",
        "@brotli//:dec",
        "@brotli//:enc",
        "@highway//:hwy",
        "@skcms",
    ],
)
